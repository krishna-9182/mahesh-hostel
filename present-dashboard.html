<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Attendance Dashboard</title>
  <style>
    :root{
      --bg: #f6f8fa;
      --card: #ffffff;
      --muted: #6b7280;
      --accent: #0f172a;
      --primary: #2563eb;
      --radius: 10px;
    }

    body {
      margin: 0;
      font-family: system-ui, Arial;
      background: var(--bg);
      color: var(--accent);
      padding: 18px;
    }

    header{
      display:flex;
      justify-content:space-between;
      margin-bottom:18px;
    }

    h1{ margin:0; font-size:1.2rem; }

    .wrapper { max-width: 980px; margin: auto; }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: 0 6px 18px rgba(15,23,42,0.06);
    }

    .tabs { display:flex; gap:8px; margin-bottom:12px; }

    .tab-btn {
      flex: 1;
      padding:10px;
      border-radius: 8px;
      border: 1px solid transparent;
      background: transparent;
      cursor:pointer;
      font-weight:600;
    }

    .tab-btn.active {
      background: var(--primary);
      color: white;
    }  
    .et-cell {
  background: #e8f0ff;  /* light blue */
  font-weight: 600;
  border-radius: 6px;
  padding: 6px 10px;
}


    .meta {
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    table {
      width:100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    thead th {
      padding:10px;
      background: #f0f4ff;
      border-bottom:1px solid #d9e3f8;
      text-align:left;
    }

    tbody td {
      padding: 12px;
      border-bottom: 1px solid #eef2f7;
    }

    .btn { padding:10px 12px; border-radius:8px; cursor:pointer; font-weight:600; border:none; }
    .refresh { background:#e8eeff; color:#2563eb; }
    .back { background:#374151; color:white; }

    .muted { color:#6b7280; padding:12px; }

    /* ---------------- MODAL POPUP ---------------- */
    #modal {
      position: fixed;
      left: 50%;
      top: 20px;
      transform: translateX(-50%);
      background: #2563eb;
      color: white;
      padding: 12px 18px;
      border-radius: 10px;
      font-weight: 600;
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 9999;
    }
    /* ------------------------------------------------ */

    @media(max-width:720px){
      table, thead, tbody, tr, th, td { display:block; }

      thead { display:none; }

      tr {
        margin-bottom:12px;
        background:white;
        padding:10px;
        border-radius:10px;
        box-shadow:0 4px 10px rgba(0,0,0,0.05);
      }

      td {
        padding:8px 6px;
        display:flex;
        justify-content:space-between;
      }

      td::before {
        content: attr(data-label);
        font-weight: bold;
        color:#374151;
      }
    }
  </style>
</head>
<body>

  <!-- ðŸ”µ MODAL POPUP -->
  <div id="modal">Marked as Present!</div>

  <div class="wrapper">
    <header>
      <div>
        <h1>Attendance â€” Today</h1>
        <div class="muted">Present & Absent Details</div>
      </div>

      <div>
        <button class="btn refresh" id="refreshBtn">Reload</button>
        <button class="btn back" id="backBtn">Back</button>
      </div>
    </header>

    <main class="card">
      <div class="meta">
        <div class="tabs">
          <button class="tab-btn active" id="tabPresent">Present</button>
          <button class="tab-btn" id="tabAbsent">Absent</button>
        </div>

        <div class="counts" id="counts">Loading...</div>
      </div>

      <div id="contentArea" class="muted">Waiting for data...</div>
    </main>
  </div>

<script>
  const API_URL = "https://hostel-erp-bef5.onrender.com/api/attendance/today/";
  const tokenKey = "access_token";

  const tabPresent = document.getElementById("tabPresent");
  const tabAbsent = document.getElementById("tabAbsent");
  const contentArea = document.getElementById("contentArea");
  const countsEl = document.getElementById("counts");
  const modal = document.getElementById("modal");

  let dataStore = null;
  let activeTab = "present";

  function escapeHtml(s){
    return String(s || "").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
  }

  /* ----------- SHOW MODAL POPUP ------------- */
  function showModal(msg) {
    modal.textContent = msg;
    modal.style.display = "block";

    setTimeout(() => {
      modal.style.display = "none";
    }, 1500);
  }
  /* ------------------------------------------- */

  async function markPresent(etNumber) {
    const token = localStorage.getItem("access_token");
    if (!token) return alert("Not logged in");

    try {
      const res = await fetch("https://hostel-erp-bef5.onrender.com/api/attendance/mark-present/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ et_number: etNumber })
      });

      if (res.ok) {
        showModal("Marked as Present!");
        load(); 
      }
    } catch (e) {}
  }

  function buildPresentTable(list){
    if (!list.length) return `<div class="muted">No present students.</div>`;

    let h = `<table><thead><tr>
      <th>ET Number</th><th>Name</th>
    </tr></thead><tbody>`;

    list.forEach(s => {
      h += `<tr>
        <td data-label="ET Number" class="et-cell">${escapeHtml(s.et_number)}</td>


        <td data-label="Name">${escapeHtml(s.student_name)}</td>
      </tr>`;
    });

    h += `</tbody></table>`;
    return h;
  }

  function buildAbsentTable(list){
    if (!list.length) return `<div class="muted">No absent students.</div>`;

    let h = `<table><thead><tr>
      <th>ET Number</th>
      <th>Name</th>
      <th>Mobile</th>
      <th>Father Mobile</th>
      <th>Action</th>
    </tr></thead><tbody>`;

    list.forEach(s => {
      h += `<tr>
        <td data-label="ET Number" class="et-cell">${escapeHtml(s.et_number)}</td>

        <td data-label="Name">${escapeHtml(s.student_name)}</td>
        <td data-label="Mobile">${escapeHtml(s.mobile_number)}</td>
        <td data-label="Father Mobile">${escapeHtml(s.father_mobile)}</td>
        <td data-label="Action">
          <button onclick="markPresent('${escapeHtml(s.et_number)}')" 
            style="padding:6px 10px; background:#2563eb; color:white; border:none; border-radius:6px; cursor:pointer;">
            Add to Present
          </button>
        </td>
      </tr>`;
    });

    h += `</tbody></table>`;
    return h;
  }

  function updateCounts(d){
    countsEl.innerHTML = `Present: <b>${d.present_students.length}</b> | Absent: <b>${d.absent_students.length}</b>`;
  }

  function render(){
    if (!dataStore) return;

    if (activeTab === "present") {
      contentArea.innerHTML = `<h3>Present Students</h3>` + 
                               buildPresentTable(dataStore.present_students);
    } else {
      contentArea.innerHTML = `<h3>Absent Students</h3>` + 
                               buildAbsentTable(dataStore.absent_students);
    }
  }

  async function load(){
    contentArea.innerHTML = "Loading...";

    const token = localStorage.getItem(tokenKey);

    if (!token) {
      contentArea.innerHTML = "Not Logged In";
      return;
    }

    try {
      const res = await fetch(API_URL, {
        headers: { "Authorization": "Bearer " + token }
      });

      const data = await res.json();
      dataStore = data;

      updateCounts(data);
      render();
    } catch (e) {
      contentArea.innerHTML = "Error loading data.";
    }
  }

  tabPresent.onclick = () => {
    activeTab = "present";
    tabPresent.classList.add("active");
    tabAbsent.classList.remove("active");
    render();
  };

  tabAbsent.onclick = () => {
    activeTab = "absent";
    tabAbsent.classList.add("active");
    tabPresent.classList.remove("active");
    render();
  };

  document.getElementById("refreshBtn").onclick = load;
  document.getElementById("backBtn").onclick = () => {
    window.location.href = "attendence.html";
  };

  load();
</script>
</body>
</html>
